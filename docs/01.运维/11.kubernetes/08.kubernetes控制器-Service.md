---
title: kubernetesæ§åˆ¶å™¨-Service
date: 2023-08-18 16:27:42
permalink: /pages/82c021/
categories:
  - è¿ç»´
  - kubernetes
tags:
  - 
---
# kubernetesæ§åˆ¶å™¨-Service

> Service æ˜¯ å°†è¿è¡Œåœ¨ä¸€ä¸ªæˆ–ä¸€ç»„ [Pod](https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/) ä¸Šçš„ç½‘ç»œåº”ç”¨ç¨‹åºå…¬å¼€ä¸ºç½‘ç»œæœåŠ¡çš„æ–¹æ³•ã€‚

ä½¿ç”¨Deploymentéƒ¨ç½²Podæ—¶ï¼ŒPodå¤§éƒ¨åˆ†éƒ½æ˜¯éšæœºåœ°éƒ¨ç½²åˆ°èŠ‚ç‚¹ä¸Šï¼Œå¹¶ä¸”ç»å¸¸è¢«åˆ é™¤é‡å»ºï¼Œè¿™å°±å¯¼è‡´äº†å®¹å™¨é—´è®¿é—®éœ€è¦ä¸€ç§å›ºå®šä¸å˜çš„èµ„æºç±»å‹æ¥è®¿é—®ã€‚

è€Œkuberneteså®šä¹‰äº†ä¸€ç§å¯¹è±¡ç±»å‹ï¼Œé€šè¿‡Serviceæ¥è®¿é—®Podï¼Œè€ŒServiceå……å½“è´Ÿè½½å‡è¡¡å™¨æ¥æŠŠè¿æ¥è½¬å‘åˆ°å…¶ä¸­ä»»æ„ä¸€ä¸ªPodå½“ä¸­ã€‚


::: center
<img src="https://xiaoliutalk.gitee.io/img/202309061418518.png" style="zoom: 33%;" />
:::



## 1. åˆ›å»ºService

### 1.1. å¸¦æœ‰æ ‡ç­¾é€‰æ‹©å™¨çš„Service

ä¸Deploymentç›¸åŒï¼Œ**Serviceä¹Ÿé€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨è¿›è¡ŒåŒ¹é…Pod**ï¼Œæ–°å»º `Service.yml` ï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  selector:
    app.kubernetes.io/name: MyApp
  ports:
    - protocol: TCP
      port: 80
      targetPort: 9376
```

è¿™ä¸ªymlæ–‡ä»¶åˆ›å»ºäº†ä¸€ä¸ªåç§°ä¸º `my-service` çš„Serviceï¼Œå¹¶åŒ¹é…æ‰€æœ‰æ ‡ç­¾ä¸º `app.kubernetes.io/name: MyApp` çš„Podï¼Œå¹¶æŠŠPodçš„9376ç«¯å£ï¼ˆåè®®ç±»å‹ä¸ºTCPï¼‰åå‘ä»£ç†åˆ°80ç«¯å£ã€‚

åˆ›å»ºè¿™ä¸ªServiceï¼Œå¹¶æŸ¥çœ‹Serviceçš„çŠ¶æ€ï¼š

```bash
kubectl apply -f Service.yml
kubectl get services
```

::: center
![](https://xiaoliutalk.gitee.io/img/202309061443455.png)
:::

- **TYPE**ï¼šService ç±»å‹ï¼Œé»˜è®¤ä¸º**ClusterIP**ï¼Œå³**åªèƒ½åœ¨é›†ç¾¤å†…éƒ¨è¿›è¡Œè®¿é—®**ï¼Œé€šè¿‡ `CLUSTER-IP:PORT` è¿›è¡Œè®¿é—®ï¼Œæˆ–è€…é€šè¿‡ `NAME:PORT` è¿›è¡Œè®¿é—®ã€‚

ä¹Ÿå¯ä»¥åœ¨Podä¸­ `.spec.containers[].ports[].name` è‡ªå®šä¹‰ç«¯å£çš„åç§°ï¼Œä¹‹ååœ¨Serviceä¸­æ ¹æ®åç§°è¿›è¡Œè°ƒç”¨ï¼Œé€šè¿‡è‡ªå®šä¹‰ç«¯å£çš„åç§°å¯ä»¥æå¤§æé«˜Serviceé…ç½®çš„çµæ´»æ€§ï¼Œä¾‹å¦‚æˆ‘æ›´æ–°äº†Podçš„ç«¯å£ï¼Œå°±ä¸å†éœ€è¦å†æ¬¡æ›´æ–°Serviceçš„targetPortï¼Œå‡å°‘äº†é…ç½®çš„å·¥ä½œé‡ï¼š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    app.kubernetes.io/name: proxy
spec:
  containers:
  - name: nginx
    image: nginx:stable
    ports:
      - containerPort: 80
        name: http-web-svc
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  selector:
    app.kubernetes.io/name: proxy
  ports:
  - name: name-of-service-port
    protocol: TCP
    port: 80
    targetPort: http-web-svc
```

### 1.2. ä¸å¸¦æ ‡ç­¾é€‰æ‹©å™¨çš„Service

é€šè¿‡ä¸è®¾ç½®æ ‡ç­¾é€‰æ‹©å™¨å¯ä»¥è‡ªå®šä¹‰åŒ¹é…Serviceçš„åç«¯æœåŠ¡ï¼Œç›¸å½“äºè‡ªå®šä¹‰äº†ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ã€‚

è€Œè¿™ä¸ªè´Ÿè½½å‡è¡¡å™¨åˆé€šè¿‡å®šä¹‰ `EndpointSlice` å¯¹è±¡å’Œ `Endpoints` å¯¹è±¡æ¥æŠŠè¿æ¥è½¬å‘åˆ°å…¶ä¸­ä»»æ„ä¸€ä¸ªIPåœ°å€å½“ä¸­ã€‚

å¯ä»¥åº”ç”¨åœ¨ä»¥ä¸‹åœºæ™¯ï¼š

- å¸Œæœ›åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨æŸä¸ªå›ºå®šçš„åç§°è€ŒéIPåœ°å€è®¿é—®å¤–éƒ¨çš„ä¸­é—´ä»¶æœåŠ¡ï¼›

- ä½¿ç”¨å…¶ä»–å‘½åç©ºé—´æˆ–è€…å…¶ä»–é›†ç¾¤çš„æœåŠ¡ï¼›
- ä»åŸºç¡€ç¯å¢ƒè¿ç§»åˆ°kubernetesæ—¶ï¼Œéœ€è¦å°†ä¸€éƒ¨åˆ†æµé‡è½¬å‘åˆ°å¤–éƒ¨æœåŠ¡å½“ä¸­ï¼›

#### 1.2.1. Endpoints

> [Endpoints](https://kubernetes.io/zh-cn/docs/reference/kubernetes-api/service-resources/endpoints-v1/) ï¼ˆè¯¥èµ„æºç±»åˆ«ä¸ºå¤æ•°ï¼‰å®šä¹‰äº†ç½‘ç»œç«¯ç‚¹çš„åˆ—è¡¨ï¼Œé€šå¸¸ç”± Service å¼•ç”¨ï¼Œä»¥å®šä¹‰å¯ä»¥å°†æµé‡å‘é€åˆ°å“ªäº› Podã€‚

ç®€å•æ¥è¯´ï¼ŒEndpointså¯¹è±¡åŒ…å«äº†éœ€è¦è¿›è¡Œåå‘ä»£ç†çš„IPå’Œç«¯å£ã€‚è€Œé’ˆå¯¹Endpointså¯¹è±¡ï¼Œåˆæ ¹æ®Serviceçš„æƒ…å†µåˆ†ä¸ºä¸¤ç§Endpointsï¼š

- **Serviceå¸¦æœ‰æ ‡ç­¾é€‰æ‹©å™¨**ï¼šç”±kubernetesç®¡ç†ï¼Œæœ‰ä¸ServiceåŒ¹é…çš„Podæ–°å»ºæˆ–è€…åˆ é™¤æ—¶ï¼Œkuberneteséƒ½ä¼šè‡ªè¡Œæ›´æ–°Endpointså¯¹è±¡ä¸­çš„ä¿¡æ¯ï¼Œæ¥åšåˆ°åŠ¨æ€çš„è´Ÿè½½å‡è¡¡ã€‚
- **Serviceä¸å¸¦æ ‡ç­¾é€‰æ‹©å™¨**ï¼šå¦‚æœåˆ›å»ºäº†ä¸åŒ…å«æ ‡ç­¾é€‰æ‹©å™¨çš„Serviceï¼Œkuberneteså°†ä¸ä¼šè‡ªåŠ¨åˆ›å»ºEndpointså¯¹è±¡ï¼Œè€Œè¿™ç§æ–¹å¼å¯ä»¥é€šè¿‡æ‰‹åŠ¨åˆ›å»ºEndpointså¯¹è±¡æ¥å®ç°Serviceä¸Endpointsçš„å¯¹è±¡ç›¸åŒ¹é…ã€‚

ä¸‹é¢æˆ‘ä»¬ä¸»è¦çœ‹ä¸€ä¸‹ä¸å¸¦æ ‡ç­¾é€‰æ‹©å™¨çš„Serviceæ˜¯å¦‚ä½•ä¸Endpointså»ºç«‹è¿æ¥çš„ï¼Œæ–°å»º `ServiceWithoutSelector_Endpoints.yml`ï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service        # Serviceçš„åç§°å¿…é¡»ä¸Endpointsçš„åç§°ç›¸åŒ¹é…
spec:
  ports:
    - protocol: TCP
      port: 80            # Serviceå¯¹å¤–æš´éœ²çš„ç«¯å£
---
apiVersion: v1
kind: Endpoints
metadata:
  name: my-service        # Endpointsçš„åç§°å¿…é¡»ä¸Serviceçš„åç§°ç›¸åŒ¹é…
subsets:
  - addresses:
    - ip: 10.1.1.1        # è¢«åå‘ä»£ç†çš„ipåœ°å€
    - ip: 10.1.1.2        # è¢«åå‘ä»£ç†çš„ipåœ°å€
    ports:
    - port: 80            # è¢«åå‘ä»£ç†çš„ç«¯å£
```

åˆ›å»ºè¿™ä¸ªServiceï¼Œå¹¶æŸ¥çœ‹Serviceå’ŒEndpointsçš„çŠ¶æ€ï¼š

```bash
kubectl apply -f ServiceWithoutSelector_Endpoints.yml
kubectl get services
kubectl get endpoints
```

::: center
![](https://xiaoliutalk.gitee.io/img/202309061839821.png)
:::

é€šè¿‡è®¿é—® `CLUSTER-IP:PORT` å³å¯æ­£å¸¸è®¿é—®å¯¹åº”çš„Serviceã€‚

#### 1.2.2. EndpointSlice

> [EndpointSlice](https://kubernetes.io/zh-cn/docs/concepts/services-networking/endpoint-slices/) å¯¹è±¡è¡¨ç¤ºæŸä¸ªæœåŠ¡çš„åç«¯ç½‘ç»œç«¯ç‚¹çš„å­é›†ï¼ˆ**åˆ‡ç‰‡**ï¼‰ã€‚

ä¾‹å¦‚ç”µå•†è¡Œä¸šåœ¨è¿›è¡Œä¿ƒé”€æ´»åŠ¨æˆ–ç§’æ€æŠ¢è´­æ´»åŠ¨æ—¶ï¼Œä¸šåŠ¡æµé‡ç›¸å¯¹è¾ƒå¤§ã€‚ä¸ºäº†åº”å¯¹è¿™ç§åœºæ™¯ï¼Œé€šå¸¸ä¼šè®¾ç½®å¼¹æ€§æ‰©å®¹ã€‚åœ¨æ´»åŠ¨è¿›è¡Œæ—¶ï¼ŒæœåŠ¡ä¼šè¿›è¡Œå¼¹æ€§ä¼¸ç¼©ç›´åˆ°èƒ½å¤Ÿæ‰¿è½½æµé‡ï¼Œè¿™æ—¶ä¼šåŸºäºå¼¹æ€§æ‰©å®¹çš„ç­–ç•¥ï¼Œä¸ºä¸šåŠ¡å¢åŠ å‰¯æœ¬æ•°ï¼Œä¹Ÿå°±æ˜¯ Pod ä¼šå˜å¤šã€‚

æ¯ä¸ª Pod éƒ½æœ‰å„è‡ªå”¯ä¸€çš„ IP ï¼Œä½†åŒæ—¶ Pod çš„ IP ä¹Ÿä¸æ˜¯å›ºå®šçš„ã€‚ä¸ºäº†åŠæ—¶è¿½è¸ª Pod IP çš„å˜åŒ–ï¼Œä»è€Œè¿›è¡Œè´Ÿè½½å‡è¡¡ï¼ŒEndpoints API æä¾›äº†åœ¨ Kubernetes ä¸­è·Ÿè¸ªç½‘ç»œç«¯ç‚¹çš„ä¸€ç§ç®€å•è€Œç›´æ¥çš„æ–¹æ³•ã€‚

ä½†éšç€ Kubernetes é›†ç¾¤å’ŒæœåŠ¡é€æ¸å¼€å§‹ä¸ºæ›´å¤šçš„åç«¯ Pod è¿›è¡Œå¤„ç†å’Œå‘é€è¯·æ±‚ï¼Œæ¯”å¦‚ä¸Šæ–‡æåˆ°å¤§æµé‡åœºæ™¯ä¸‹ï¼ŒPod æ•°é‡ä¼šè¢«ä¸æ–­æ‰©å®¹ï¼ŒEndpoints API ä¹Ÿå°†å˜å¾—è¶Šå¤§ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒEndpoints API å±€é™æ€§å˜å¾—è¶Šæ¥è¶Šæ˜æ˜¾ï¼Œç”šè‡³æˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªå±€é™æ€§é—®é¢˜ï¼Œåœ¨ Kubernetes v1.21 çš„ç‰ˆæœ¬ä¸­å¼•å…¥äº†å¯¹ Endpointslice API çš„æ”¯æŒï¼Œè§£å†³äº† Endpoints API å¤„ç†å¤§é‡ç½‘ç»œç«¯ç‚¹å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ï¼ŒåŒæ—¶æä¾›äº†å¯æ‰©å±•å’Œå¯ä¼¸ç¼©çš„èƒ½åŠ›ã€‚

**Endpoints åœ¨æµé‡é«˜å³°æ—¶çš„å˜åŒ–ï¼š**

::: center
![](https://xiaoliutalk.gitee.io/img/202309071002398.png)
:::

**Endpointslices åœ¨æµé‡é«˜å³°æ—¶çš„å˜åŒ–ï¼š**

::: center
![](https://xiaoliutalk.gitee.io/img/202309071002659.png)
:::

ä¸‹é¢æˆ‘ä»¬ä¸»è¦çœ‹ä¸€ä¸‹ä¸å¸¦æ ‡ç­¾é€‰æ‹©å™¨çš„Serviceæ˜¯å¦‚ä½•ä¸EndpointSliceå»ºç«‹è¿æ¥çš„ï¼Œæ–°å»º `ServiceWithoutSelector_EndpointSlice.yml`ï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service                    # Serviceçš„åç§°å¿…é¡»ä¸Endpointsçš„æ ‡ç­¾kubernetes.io/service-nameç›¸åŒ¹é…
spec:
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8443
---
apiVersion: discovery.k8s.io/v1
kind: EndpointSlice
metadata:
  name: my-service-1                  # æŒ‰æƒ¯ä¾‹å°†Serviceçš„åç§°ç”¨ä½œEndpointSliceåç§°çš„å‰ç¼€
  labels:
    # Endpointsçš„æ ‡ç­¾kubernetes.io/service-nameå¿…é¡»ä¸Serviceçš„åç§°ç›¸åŒ¹é…
    kubernetes.io/service-name: my-service
addressType: IPv4                     # åœ°å€ç±»å‹ï¼Œå¯ä»¥é…ç½®IPv4ï¼ŒIPv6ï¼ŒFQDNä¸‰ç§å‚æ•°
ports:
  - appProtocol: http                 # å…³è”çš„æœåŠ¡çš„åè®®
    protocol: TCP                     # åè®®ç±»å‹
    port: 8443
endpoints:
  - addresses:
      - "10.1.1.1"                    # è¢«åå‘ä»£ç†çš„ipåœ°å€
      - "10.1.1.2"                    # è¢«åå‘ä»£ç†çš„ipåœ°å€
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒServiceçš„åç§°ä¸Endpointsçš„æ ‡ç­¾ `kubernetes.io/service-name` ç›¸åŒ¹é…ï¼Œä¸EndpointsåŒ¹é…æ–¹å¼ç•¥æœ‰ä¸åŒã€‚

åŒæ ·åˆ›å»ºè¿™ä¸ªServiceï¼Œå¹¶æŸ¥çœ‹Serviceå’ŒEndpointSliceçš„çŠ¶æ€ï¼š

```bash
kubectl get services
kubectl get endpointslices
```

::: center
![](https://xiaoliutalk.gitee.io/img/202309071555143.png)
:::

Serviceä¸EndpointSliceéƒ½æˆåŠŸè¢«åˆ›å»ºå¹¶ä¸”å¯ä»¥æ­£å¸¸è®¿é—®ã€‚

## 2. Serviceçš„ç±»å‹

Service Typeï¼ˆæœåŠ¡ç±»å‹ï¼‰ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ç§ï¼š

- **ClusterIP**ï¼šé»˜è®¤å€¼ï¼Œ**åªèƒ½åœ¨é›†ç¾¤å†…éƒ¨è¿›è¡Œè®¿é—®**ã€‚é€šè¿‡ `CLUSTER-IP:PORT` è¿›è¡Œè®¿é—®ï¼Œæˆ–è€…é€šè¿‡ `NAME:PORT` è¿›è¡Œè®¿é—®ã€‚
- **NodePort**ï¼šåœ¨æ‰€æœ‰å®‰è£…äº† kube-proxy çš„èŠ‚ç‚¹ä¸Šæ‰“å¼€ä¸€ä¸ªç«¯å£ï¼Œæ­¤ç«¯å£å¯ä»¥ä»£ç†è‡³åç«¯Podï¼Œå¯ä»¥é€šè¿‡NodePortä»é›†ç¾¤å¤–éƒ¨è®¿é—®é›†ç¾¤å†…çš„æœåŠ¡ï¼Œæ ¼å¼ä¸º `NodeIP:NodePort` ã€‚
- **LoadBalancer**ï¼šä½¿ç”¨äº‘æä¾›å•†çš„è´Ÿè½½å‡è¡¡å™¨å…¬å¼€Serviceã€‚
- **ExternalName**ï¼šé€šè¿‡è¿”å›å®šä¹‰çš„CNAMEåˆ«åï¼Œå°†Serviceæ˜ å°„åˆ°å¯è¢«DNSè§£æçš„å…¶ä»–åŸŸåã€‚

ClusterIPè¿™é‡Œçœç•¥ï¼Œç›´æ¥åˆ†æä¸‹Serviceå¯¹å¤–æš´éœ²çš„ä¸‰ç§ç±»å‹ï¼Œ**NodePort**ï¼Œ**LoadBalancer**å’Œ**ExternalName**ã€‚

### 2.1. NodePort

é€šè¿‡åˆ›å»ºServiceï¼Œå¹¶å°†Typeè®¾ç½®ä¸ºNodePortæ¥å®ç°é€šè¿‡NodePortä»é›†ç¾¤å¤–éƒ¨è®¿é—®é›†ç¾¤å†…çš„æœåŠ¡ã€‚

::: center
<img src="https://xiaoliutalk.gitee.io/img/202309071828671.png" style="zoom:50%;" />
:::

é€šè¿‡å›¾ç‰‡æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼Œå°†Typeè®¾ç½®ä¸ºNodePortå¯ä»¥å®ç°åœ¨æ¯ä¸€ä¸ªé›†ç¾¤èŠ‚ç‚¹ä¸Šéƒ½ä¼šæ‰“å¼€ä¸€ä¸ªNodePortï¼Œè€Œé€šè¿‡è®¿é—®ä»»æ„ä¸€ä¸ªé›†ç¾¤èŠ‚ç‚¹çš„IP+NodePortå°±å¯ä»¥ä»å¤–éƒ¨è®¿é—®åˆ°åç«¯çš„Podã€‚

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  type: NodePort
  selector:
    app.kubernetes.io/name: MyApp
  ports:
    # ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼ŒtargetPortè¢«è®¾ç½®ä¸ºä¸portå­—æ®µç›¸åŒçš„å€¼
    - port: 80
      targetPort: 80
      # å¯é€‰å­—æ®µï¼Œä¸æŒ‡å®šæ­¤å­—æ®µçš„æƒ…å†µä¸‹ï¼Œkubernetesä¼šä»æŸä¸ªèŒƒå›´å†…åˆ†é…ä¸€ä¸ªç«¯å£å·ï¼ˆé»˜è®¤ï¼š30000-32767ï¼‰
      nodePort: 30007
```

å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è®¿é—®æ­¤Serciceï¼š

- **é›†ç¾¤å†…éƒ¨**ï¼šé€šè¿‡ `CLUSTER-IP:PORT` è¿›è¡Œè®¿é—®ï¼Œæˆ–è€…é€šè¿‡ `NAME:PORT` è¿›è¡Œè®¿é—®ã€‚
- **é›†ç¾¤å¤–éƒ¨**ï¼šä»»æ„ä¸€ä¸ªé›†ç¾¤èŠ‚ç‚¹çš„å®¿ä¸»æœºIP+NodePortè¿›è¡Œè®¿é—®ã€‚

### 2.2. LoadBalancer

> **LoadBalanceråº•å±‚ä¾èµ–äºNodePortã€‚**

ä½¿ç”¨NodePortå°±åˆæ¶‰åŠåˆ°è´Ÿè½½å‡è¡¡çš„é—®é¢˜ï¼Œè€ŒLoadBalancerå°±æ˜¯ä¸ºäº†è§£å†³K8så°†å†…éƒ¨æœåŠ¡å¯¹å¤–æš´éœ²æ—¶å¦‚ä½•è¿›è¡Œè´Ÿè½½å‡è¡¡çš„é—®é¢˜è€Œå‡ºç°çš„ã€‚

::: center
<img src="https://xiaoliutalk.gitee.io/img/202309081812542.png" style="zoom:50%;" />
:::

å‡è®¾æˆ‘ä»¬æœ‰ä¸€å¥—é˜¿é‡Œäº‘K8sç¯å¢ƒï¼Œè¦å°†K8så†…éƒ¨çš„ä¸€ä¸ªæœåŠ¡é€šè¿‡LoadBalanceræ–¹å¼æš´éœ²å‡ºå»ï¼Œå¯ä»¥å°†Service typeè®¾å®šä¸ºLoadBalancerã€‚æœåŠ¡å‘å¸ƒåï¼Œé˜¿é‡Œäº‘K8sä¸ä»…ä¼šè‡ªåŠ¨åˆ›å»ºæœåŠ¡çš„NodePortç«¯å£è½¬å‘ï¼ŒåŒæ—¶ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬ç”³è¯·ä¸€ä¸ªSLBï¼Œæœ‰ç‹¬ç«‹å…¬ç½‘IPï¼Œå¹¶ä¸”é˜¿é‡Œäº‘K8sä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨æŠŠSLBæ˜ å°„åˆ°åå°K8sé›†ç¾¤çš„å¯¹åº”NodePortä¸Šã€‚è¿™æ ·ï¼Œé€šè¿‡SLBçš„å…¬ç½‘IPï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¿é—®åˆ°K8så†…éƒ¨æœåŠ¡ï¼Œé˜¿é‡Œäº‘SLBè´Ÿè½½å‡è¡¡å™¨ä¼šåœ¨èƒŒååšè´Ÿè½½å‡è¡¡ã€‚

å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå¦‚æœæ˜¯åœ¨æœ¬åœ°å¼€å‘æµ‹è¯•ç¯å¢ƒé‡Œå¤´æ­å»ºçš„K8sï¼Œä¸€èˆ¬ä¸æ”¯æŒLoadBalancerï¼Œå› ä¸ºé€šè¿‡NodePortåšæµ‹è¯•è®¿é—®å°±å¤Ÿäº†ã€‚ä½†æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒæˆ–è€…å…¬æœ‰äº‘ä¸Šçš„K8sï¼Œä¾‹å¦‚GCPæˆ–è€…é˜¿é‡Œäº‘K8sï¼ŒåŸºæœ¬éƒ½æ”¯æŒè‡ªåŠ¨åˆ›å»ºLoadBalancerã€‚

å¦‚æœæ˜¯è‡ªå»ºé›†ç¾¤ï¼Œå¯ä»¥é€šè¿‡å®‰è£… [MetalLB](https://metallb.universe.tf/) æ¥ä½¿ç”¨ LoadBalancerã€‚è¿™é‡Œæš‚æ—¶ä¸è·Ÿè¿›è®²è§£è‡ªå»ºé›†ç¾¤çš„LoadBalancerç›¸å…³é…ç½®ã€‚

```yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app: nginx
  name: my-nginx-svc
  namespace: default
spec:
  ports:
  - port: 80
    protocol: TCP
    targetPort: 80
  selector:
    app: nginx
  type: LoadBalancer
```

å…¬æœ‰äº‘å…·ä½“é…ç½®å¯ä»¥å‚è€ƒé˜¿é‡Œäº‘å®˜æ–¹æä¾›çš„ [é€šè¿‡ä½¿ç”¨è‡ªåŠ¨åˆ›å»ºSLBçš„æœåŠ¡å…¬å¼€åº”ç”¨](https://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/use-an-automatically-created-slb-instance-to-expose-an-application?spm=a2c4g.11186623.0.0.13ee8d540KmX6w) è¿™ç¯‡æ–‡ç« è¿›è¡Œé…ç½®ã€‚

### 2.3. ExternalName

é€šè¿‡è¿”å›å®šä¹‰çš„CNAMEåˆ«åï¼Œå°†Serviceæ˜ å°„åˆ°å¯è¢«DNSè§£æçš„å…¶ä»–åŸŸåã€‚

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  type: ExternalName
  externalName: my.database.example.com
```

è¿™ä¸ªymlæŠŠåç§°ä¸ºmy-serviceçš„Serviceæ˜ å°„åˆ°äº†my.database.example.comè¿™ä¸ªåŸŸåã€‚

### 2.4. externalIPs

> å®šä¹‰ Service æ—¶ï¼Œä½ å¯ä»¥ä¸ºä»»ä½•[æœåŠ¡ç±»å‹](https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/#publishing-services-service-types)æŒ‡å®š externalIPsã€‚

externalIPså¯ä»¥è¯´æ˜¯Serviceç±»å‹çš„æ‰©å……ã€‚

å¦‚æœæœ‰å¤–éƒ¨å¯è¾¾çš„ IPï¼ˆå¦‚ç½‘ç»œé€šè¿‡BGPï¼ŒOSPFç­‰è·¯ç”±åè®®è¿›è¡Œå®£å‘Šè·¯ç”±å¯è¾¾é›†ç¾¤èŠ‚ç‚¹ï¼‰ ï¼Œå³**é›†ç¾¤å¤–èƒ½é€šè¿‡è¿™ä¸ªIPè®¿é—®åˆ°é›†ç¾¤å†…çš„Nodeï¼ˆè‡³å°‘å…¶ä¸­ä¸€å°èŠ‚ç‚¹ï¼‰**ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿™äº›Nodeå°†æµé‡è½¬å‘åˆ°Serviceï¼Œå¹¶æä¾›è´Ÿè½½å‡è¡¡ã€‚

::: center
<img src="https://xiaoliutalk.gitee.io/img/202309281443742.png" style="zoom:50%;" />
:::

> ğŸ””  `external IP` ä¸€èˆ¬ç”±æ•°æ®ä¸­å¿ƒæˆ–è€…ç½‘ç»œç®¡ç†å‘˜ç®¡ç†ï¼Œç‹¬ç«‹äºkubernetesä¹‹å¤–ã€‚

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  selector:
    app.kubernetes.io/name: nginx
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
  externalIPs:
    - 192.168.7.30
```

è¿™ä¸ªå« `my-service` çš„æœåŠ¡å¯ä»¥åœ¨ `192.168.7.30:80` ä¸Šè¢«æ­£å¸¸è®¿é—®ã€‚

## 3. æœåŠ¡å‘ç°

kubernetesæ”¯æŒä¸¤ç§ç±»å‹çš„æœåŠ¡å‘ç°ï¼šç¯å¢ƒå˜é‡å’ŒDNSã€‚

### 3.1. ç¯å¢ƒå˜é‡

å½“Podéƒ¨ç½²åˆ°ä¸€ä¸ªNodeèŠ‚ç‚¹åï¼Œkubeletä¼šåœ¨å…¶ä¸­ä¸ºæ¯ä¸ªæ´»è·ƒçš„Serviceæ·»åŠ ä¸€ç»„ç¯å¢ƒå˜é‡ï¼Œå¹¶ä»¥ `{SERVICE_NAME}_SERVICE_HOST` å’Œ `{SERVICE_NAME}_SERVICE_PORT` æ ¼å¼å‘½åçš„å˜é‡ï¼Œå…¶ä¸­æœåŠ¡åéƒ½è½¬æ¢ä¸ºå¤§å†™å­—æ¯ï¼Œ`.` å’Œ `-` è½¬æ¢ä¸º `_` ã€‚

```yaml
```



### 3.2. DNS

å‚è€ƒæ–‡ç« åŠä¹¦ç±ï¼š

- [Service](https://kubernetes.io/docs/concepts/services-networking/service/)

- [Kubernetes in Action](http://product.dangdang.com/26439199.html)
- [Kubernetes in Action, Second Edition](https://www.manning.com/books/kubernetes-in-action-second-edition)
- [æ·±å…¥å‰–æKubernetes](http://product.dangdang.com/29222386.html)

- [äº‘åŸç”ŸKuberneteså…¨æ ˆæ¶æ„å¸ˆå®æˆ˜](http://product.dangdang.com/29404674.html)

- [Kubernetesä¸Šåƒè§„æ¨¡Podæœ€ä½³å®è·µ ](https://it.sohu.com/a/611171687_827544)

- [Kubernetesç½‘ç»œä¸‰éƒ¨æ›²ä¹‹ä¸‰ ~ NodePort vs LoadBalancer vs Ingress](https://blog.csdn.net/yang75108/article/details/101268208)

- [[è¯‘] åŸºäº BPF/XDP å®ç° K8s Service è´Ÿè½½å‡è¡¡ (LPC, 2020)](http://arthurchiao.art/blog/cilium-k8s-service-lb-zh/)
