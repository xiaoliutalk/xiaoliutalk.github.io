---
title: PlaybookåŸºç¡€å…¥é—¨
date: 2023-02-16 16:59:51
permalink: /pages/000a4f/
categories:
  - ã€ŠAnsibleæƒå¨æŒ‡å—ã€‹
tags:
  - 
---
# PlaybookåŸºç¡€å…¥é—¨

## 1. Playbookè¯­æ³•ç®€ä»‹

Playbooké‡‡ç”¨YAMLè¯­æ³•ç¼–å†™ï¼Œå‚è€ƒ[YAML å…¥é—¨æ•™ç¨‹](https://www.runoob.com/w3cnote/yaml-intro.html)è¿›è¡Œå­¦ä¹ ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚

äº†è§£äº†æ™®é€šçš„YAMLæ ¼å¼æ–‡ä»¶ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ­£å¼çš„Playbookå†…å®¹æ˜¯ä»€ä¹ˆæ ·çš„ï¼š

```yaml
---
#è¿™ä¸ªæ˜¯ä½ é€‰æ‹©çš„ä¸»æœº
- hosts: webservers
  #è¿™ä¸ªæ˜¯å˜é‡
  vars:
    http_port: 80
    max_clients: 200
    #è¿œç«¯çš„æ‰§è¡Œæƒé™
    remote_user: root
  tasks:
   - name: install Apache
     yum: name={{ item }} state=present
     with_items:
         - httpd
         - httpd-devel
    # ç¡®è®¤å·²å®‰è£…apache
    - name: ensure that apache is installed
      yum: 
        name: httpd
        state: present
    #åˆ©ç”¨yumæ¨¡å—æ¥æ“ä½œ
    - name: ensure apache is at the latest version
      yum: pkg=httpd state=latest
    - name: write the apache config file
      template: src=/srv/httpd.j2 dest=/etc/httpd/conf/httpd.conf
      #è§¦å‘é‡å¯æœåŠ¡å™¨
      notify: restart apache
    - name: ensure apache is running
      service: name=httpd state=started
  #è¿™é‡Œçš„restart apache å’Œä¸Šé¢çš„è§¦å‘æ˜¯é…å¯¹çš„ã€‚è¿™å°±æ˜¯handlersçš„ä½œç”¨ã€‚ç›¸å½“äºŽtag
  handlers:
    - name: restart apache
      service: name=httpd state=restarted
```
1. éœ€è¦ä»¥â€œ---â€ï¼ˆ3ä¸ªå‡å·ï¼‰å¼€å§‹ï¼Œä¸”éœ€é¡¶è¡Œé¦–å†™ã€‚
2. æ¬¡è¡Œå¼€å§‹æ­£å¸¸å†™Playbookçš„å†…å®¹ã€‚å¯ä»¥æŒ‡å®šæ­¤Playbookçš„ç”¨é€”ã€‚
3. ç¼©è¿›å¿…é¡»æ˜¯ç»Ÿä¸€çš„ï¼Œä¸èƒ½å°†ç©ºæ ¼å’ŒTabæ··ç”¨ã€‚
4. ç¼©è¿›çš„çº§åˆ«å¿…é¡»æ˜¯ä¸€è‡´çš„ï¼ŒåŒæ ·çš„ç¼©è¿›ä»£è¡¨åŒæ ·çš„çº§åˆ«ï¼Œç¨‹åºåˆ¤åˆ«é…ç½®çš„çº§åˆ«æ˜¯é€šè¿‡ç¼©è¿›ç»“åˆæ¢è¡Œæ¥å®žçŽ°çš„ã€‚
5. YAMLæ–‡ä»¶å†…å®¹å’ŒLinuxç³»ç»Ÿå¤§å°å†™åˆ¤æ–­æ–¹å¼ä¿æŒä¸€è‡´ï¼Œæ˜¯åŒºåˆ«å¤§å°å†™çš„ï¼Œk/vçš„å€¼å‡éœ€å¤§å°å†™æ•æ„Ÿã€‚
6. `key/value`çš„å€¼å¯åŒè¡Œå†™ä¹Ÿå¯æ¢è¡Œå†™ã€‚åŒè¡Œä½¿ç”¨â€œï¼šâ€åˆ†éš”ï¼Œæ¢è¡Œå†™éœ€è¦ä»¥â€œ-â€åˆ†éš”ã€‚
7. ä¸€ä¸ªå®Œæ•´çš„ä»£ç å—åŠŸèƒ½éœ€æœ€å°‘å…ƒç´ åŒ…æ‹¬`name` å’Œ `task`ã€‚
9. ä¸€ä¸ªnameåªèƒ½åŒ…æ‹¬ä¸€ä¸ªtaskã€‚
9. åœ¨æ¯ä¸€ä¸ªplayå½“ä¸­ï¼Œéƒ½å¯ä»¥ä½¿ç”¨`with_items`æ¥å®šä¹‰å˜é‡ï¼Œå¹¶é€šè¿‡**{{å˜é‡å}}**çš„å½¢å¼æ¥ç›´æŽ¥ä½¿ç”¨ã€‚

## 2. Playbookç»„ä»¶

### 2.1. handlers

ä½¿ç”¨`handlers`å…³é”®å­—ï¼ŒæŒ‡æ˜Žå“ªäº›ä»»åŠ¡å¯ä»¥è¢«è°ƒç”¨ï¼Œä¸Ž`notify`é…å¥—ä½¿ç”¨ã€‚

- åªæœ‰å½“`tasks`ä¸­çš„ä»»åŠ¡**çœŸæ­£æ‰§è¡Œ**ä»¥åŽï¼ˆ**çœŸæ­£çš„è¿›è¡Œå®žé™…æ“ä½œï¼Œé€ æˆäº†å®žé™…çš„æ”¹å˜**ï¼‰ï¼Œ`handlers`ä¸­è¢«è°ƒç”¨çš„ä»»åŠ¡æ‰ä¼šæ‰§è¡Œï¼Œå¦åˆ™`Playbook`ä¸ä¼šæ‰§è¡Œ`notify`ä¸­æŒ‡å®šçš„`handlers`å…³é”®å­—ï¼ˆåŒ…æ‹¬æ¡ä»¶åˆ¤æ–­ï¼‰ã€‚
- `handlers`ä¸­å¯ä»¥æœ‰å¤šä¸ªä»»åŠ¡ï¼Œè¢«`tasks`ä¸­ä¸åŒçš„ä»»åŠ¡`notify`ã€‚
- ä¸€ä¸ª`task`å¯ä»¥åŒæ—¶è°ƒç”¨å¤šä¸ª`handlers`ã€‚
- `handlers`å¯ä»¥è°ƒç”¨`handlers`ï¼Œç›´æŽ¥åœ¨`handlers`ä¸­ä½¿ç”¨`notify`å³å¯ã€‚

ç¤ºä¾‹å†…å®¹å¦‚ä¸‹ï¼š

```yaml
---
#è¿™ä¸ªæ˜¯ä½ é€‰æ‹©çš„ä¸»æœº
- hosts: webservers
  #è¿™ä¸ªæ˜¯å˜é‡
  vars:
    http_port: 80
    max_clients: 200
    #è¿œç«¯çš„æ‰§è¡Œæƒé™
    remote_user: root
  tasks:
    - name: install Apache
      yum: name={{ item }} state=present
      with_items:
          - httpd
          - httpd-devel
    # ç¡®è®¤å·²å®‰è£…apache
    - name: ensure that apache is installed
      yum:
        name: httpd
        state: present
    # åˆ©ç”¨yumæ¨¡å—æ¥æ“ä½œ
    - name: ensure apache is at the latest version
      yum: pkg=httpd state=latest
    # æ›¿æ¢é…ç½®æ–‡ä»¶
    - name: write the apache config file
      template: src=/srv/httpd.j2 dest=/etc/httpd/conf/httpd.conf
      # è§¦å‘é‡å¯æœåŠ¡å™¨
      notify: restart apache
    - meta: flush_handlers
    - name: ensure apache is running
      service: name=httpd state=started

  handlers:
    - name: restart apache
      service: name=httpd state=restarted
```

æ‰§è¡Œç»“æžœï¼š

![image-20230220153100833](https://xiaoliutalk.gitee.io/img/202302201531210.png)

`handler`æ‰§è¡Œçš„é¡ºåºä¸Ž`handler`åœ¨`playbook`ä¸­å®šä¹‰çš„é¡ºåºæ˜¯ç›¸åŒçš„ï¼Œä¸Ž`handler`è¢«`notify`çš„é¡ºåºæ— å…³ã€‚å¦‚æžœéœ€è¦æ‰§è¡Œå®ŒæŸäº›`task`ä»¥åŽç«‹å³æ‰§è¡Œå¯¹åº”çš„`handler`ï¼Œåˆ™éœ€è¦ä½¿ç”¨`meta`ï¼š

ç¤ºä¾‹å†…å®¹å¦‚ä¸‹ï¼š

```yaml
---
# æ·»åŠ metaè¿›è¡Œæµ‹è¯•
- hosts: test
  tasks: 
    - name: make test1
      file:
        path: /tmp/test1
        state: directory
      notify: testfile1
    # ç«‹å³æ‰§è¡Œä¹‹å‰çš„taskæ‰€å¯¹åº”handler
    - meta: flush_handlers
    - name: make test2
      file:
        path: /tmp/test2
        state: directory
      notify: testfile2

  handlers:
    - name: testfile1
      file:
        path: /tmp/test1/testfile1
        state: touch
    - name: testfile2
      file:
        path: /tmp/test2/testfile2
        state: touch
```

æ‰§è¡Œç»“æžœï¼š

![image-20230220153740881](https://xiaoliutalk.gitee.io/img/202302201537189.png)

### 2.2. çŽ¯å¢ƒå˜é‡

#### 2.2.1. è‡ªå®šä¹‰çŽ¯å¢ƒå˜é‡

ansibleä¸­è®¾ç½®å’Œä½¿ç”¨çŽ¯å¢ƒå˜é‡çš„æ–¹æ³•å¾ˆå¤šï¼Œé€šå¸¸å¯ä»¥é€šè¿‡ç”¨æˆ·å®¶ç›®å½•ä¸‹çš„`.bashrc`ã€`.bash_profile`ï¼Œæˆ–è€…æ˜¯`/etc`ç›®å½•ä¸‹é¢çš„`profile`ï¼Œä»¥åŠ`profile.d`æ–‡ä»¶å¤¹æ¥è‡ªå®šä¹‰çŽ¯å¢ƒå˜é‡ã€‚

é€šè¿‡`.bash_profile`æ¥è‡ªå®šä¹‰çŽ¯å¢ƒå˜é‡ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```yaml
---
- hosts: test
  tasks: 
    # lineinfileæ¨¡å—ï¼ŒåŠŸèƒ½æœ‰ç‚¹ç±»ä¼¼sedï¼Œå¸¸ç”¨åŠŸèƒ½ï¼šå¯¹æ–‡ä»¶çš„è¡Œæ›¿æ¢ã€æ’å…¥ã€åˆ é™¤
    # æ›¿æ¢ENV_VARä¸ºvalueï¼Œå¦‚æžœregexpæœªåŒ¹é…åˆ°è¡Œçš„è¯ï¼Œå°±æ˜¯æ–°å¢žçŽ¯å¢ƒå˜é‡ENV_VAR
    - name: ä¸ºè¿œç¨‹ä¸»æœºä¸Šçš„ç”¨æˆ·æŒ‡å®šçŽ¯å¢ƒå˜é‡
      lineinfile: 
        dest: ~/.bash_profile
        regexp: ^ENV_VAR=
        line: ENV_VAR=value
    - name: èŽ·å–åˆšåˆšæŒ‡å®šçš„çŽ¯å¢ƒå˜é‡ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°è‡ªå®šä¹‰å˜é‡fooä¸­
      shell: 'source ~/.bash_profile && echo $ENV_VAR'
      register: foo
    - name: æ‰“å°å‡ºçŽ¯å¢ƒå˜é‡
      debug: msg="The variable is {{ foo.stdout }}"
```

#### 2.2.2. é¢„å®šä¹‰çŽ¯å¢ƒå˜é‡ï¼ˆæœªå®Œæˆï¼‰

å‚è€ƒ [é…ç½®çŽ¯å¢ƒ (åœ¨ä»£ç†çŽ¯å¢ƒä¸­)](http://www.ansible.com.cn/docs/playbooks_environment.html)

å¯¹äºŽæŸä¸€ä¸ª`Playbook`æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`environment`é€‰é¡¹æ¥ä¸ºå…¶è®¾ç½®å•ç‹¬çš„çŽ¯å¢ƒå˜é‡ã€‚

ç¤ºä¾‹ï¼š

```yaml
---
- hosts: localhost 	
  vars:
    http_proxy: http://example-proxy:80/
    https_proxy: https:// example-proxy:443/
  tasks:
      - name: ä½¿ç”¨æŒ‡å®šçš„ä»£ç†æœåŠ¡å™¨ä¸‹è½½æ–‡ä»¶
        get_url: url=http://www.example.com/file.tar.gz dest=~/Downloads/
          environment: var_proxy
```

### 2.3. å˜é‡

Ansibleä¸­å˜é‡çš„å‘½åè§„åˆ™ä¸Žå…¶ä»–è¯­è¨€æˆ–ç³»ç»Ÿä¸­å˜é‡çš„å‘½åè§„åˆ™éžå¸¸ç›¸ä¼¼ã€‚åœ¨`ansible`ä¸­ï¼Œå˜é‡ä»¥**è‹±æ–‡å¤§å°å†™å­—æ¯**å¼€å¤´ï¼Œä¸­é—´å¯ä»¥åŒ…å«ä¸‹åˆ’çº¿ï¼ˆ_ï¼‰å’Œæ•°å­—ï¼Œåº”é¿å…å˜é‡åä¸­ä½¿ç”¨å¤§å°å†™å­—æ¯æ··åˆçš„é©¼å³°å¼å†™æ³•ã€‚

#### 2.3.1. Playbookå˜é‡

Ansibleæœ‰å¤šç§ä¸åŒçš„é€”å¾„æ¥å®šä¹‰å˜é‡ã€‚

- é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šå˜é‡ï¼Œå¦‚ï¼š`ansible-playbook example.yml --extra-vars "foo=bar"`

- ä½¿ç”¨`vars`ä»£ç å—æŒ‡å®šå˜é‡ï¼š

  ```yaml
  ---
  - hosts: test
    vars:
        foo: bar
    tasks:
        # Prints "Variable 'foo' is set to bar".
        - debug: msg="Variable 'foo' is set to {{ foo }}"
  ```
  
- ä½¿ç”¨`vars_files`ä»£ç å—æ¥å¼•ç”¨å˜é‡æ–‡ä»¶ï¼š

  ```yaml
  ---
  - hosts: test
    vars_files:
        - vars.yml
    tasks:
        - debug: msg="Variable 'foo' is set to {{ foo }}"
  # vars.ymlå†…å®¹
  ---
  foo: bar
  ```

ç¤ºä¾‹ï¼šé€šè¿‡æŒ‡å®š`ansible_os_family`æ¥åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸Šå®‰è£…ä¸åŒçš„åŒ…çš„æ•ˆæžœï¼šå‚è€ƒï¼š[A list with OS Family members](https://github.com/ansible/ansible/blob/37ae2435878b7dd76b812328878be620a93a30c9/lib/ansible/module_utils/facts.py#L267)

```bash
---
- hosts: example
  vars_files:
- [ "apache_{{ ansible_os_family }}.yml", "apache_default.yml" ]
  tasks:
      - service: name={{ apache }} state=running
# apache_RedHat.ymlå†…å®¹
---
apache: httpd
# apache_default.ymlå†…å®¹
---
apache: apache2
```

Ansibleä¼šä¸»åŠ¨è¯»å–è¿œç¨‹ä¸»æœºçš„`Facts`ä¿¡æ¯ï¼Œå¦‚æžœèŽ·å–è¿œç¨‹ä¸»æœºçš„`ansible_os_family`çš„å€¼ï¼Œé‚£å°†ä¼šæ‰¾åˆ°`apache_RedHat.yml`çš„å˜é‡æ‰§è¡Œï¼Œæœªæ‰¾åˆ°æ–‡ä»¶åˆ™æ‰§è¡Œ`apache_default.yml`çš„å˜é‡ã€‚

#### 2.3.2. Inventoryå®šä¹‰å˜é‡

åœ¨æ‰§è¡ŒAnsibleå‘½ä»¤æ—¶ï¼ŒAnsibleé»˜è®¤ä¼šä»Ž`/etc/ansible/host_vars/`å’Œ`/etc/ansible/group_vars/`ä¸¤ä¸ªç›®å½•ä¸‹è¯»å–å˜é‡å®šä¹‰ï¼Œå¦‚æžœæ²¡æœ‰è¿™ä¸¤ä¸ªç›®å½•ï¼Œå¯ä»¥ç›´æŽ¥æ‰‹åŠ¨åˆ›å»ºï¼Œå¹¶ä¸”å¯ä»¥åœ¨è¿™ä¸¤ä¸ªç›®å½•ä¸­åˆ›å»ºä¸Ž**Hostsæ–‡ä»¶ä¸­ä¸»æœºå**æˆ–**ç»„å**åŒåçš„æ–‡ä»¶æ¥å®šä¹‰å˜é‡ã€‚

æˆ‘ä»¬è¿˜å¯ä»¥åœ¨`group_vars`å’Œ`host_vars`ä¸¤ä¸ªæ–‡ä»¶å¤¹ä¸‹å®šä¹‰`all`æ–‡ä»¶ï¼Œæ¥ä¸€æ¬¡æ€§åœ°ä¸ºæ‰€æœ‰çš„ä¸»æœºç»„å’Œä¸»æœºå®šä¹‰å˜é‡ã€‚

#### 2.3.3. æ³¨å†Œå˜é‡

æ³¨å†Œå˜é‡ï¼Œå…¶å®žå°±æ˜¯å°†æ“ä½œçš„ç»“æžœï¼ŒåŒ…æ‹¬æ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰å’Œæ ‡å‡†é”™è¯¯è¾“å‡ºï¼ˆstderrï¼‰ï¼Œä¿å­˜åˆ°å˜é‡ä¸­ï¼Œç„¶åŽå†æ ¹æ®è¿™ä¸ªå˜é‡çš„å†…å®¹æ¥å†³å®šä¸‹ä¸€æ­¥çš„æ“ä½œã€‚å‚è€ƒçŽ¯å¢ƒå˜é‡ç« èŠ‚è¿›è¡Œæ“ä½œå³å¯ã€‚

#### 2.3.4. é«˜é˜¶å˜é‡

**æ™®é€šå˜é‡**

åœ¨Ansibleå‘½ä»¤è¡Œã€Hostsæ–‡ä»¶ï¼Œæˆ–è€…åœ¨Playbookå’Œå˜é‡å®šä¹‰æ–‡ä»¶ä¸­å®šä¹‰çš„å˜é‡éƒ½  è¢«ç§°ä¸ºç®€å•å˜é‡æˆ–æ™®é€šå˜é‡ã€‚

å¯ä»¥åœ¨`Playbook`ä¸­ä½¿ç”¨åŒå¤§æ‹¬å·åŠ å˜é‡åæ¥è¯»å–å˜é‡å†…å®¹ï¼Œå½¢å¦‚`{{variable}}`ï¼Œå¦‚ä¸Šæ–‡ä¸­æåŠåˆ°çš„ä½¿ç”¨`vars`ä»£ç å—æŒ‡å®šå˜é‡ã€‚

**æ•°ç»„å˜é‡**

ç”±äºŽAnsibleæ˜¯åŸºäºŽPythonè¯­è¨€å¼€å‘çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºåˆ—è¡¨å˜é‡ã€‚å¦‚ï¼š

```yaml
# Pythonè¯­æ³•æ ¼å¼
foo[0]
# Jinja2è¯­æ³•
foo|first
```

**å¤šçº§å˜é‡**

å¤šçº§å˜é‡ç±»ä¼¼äºŽPythonä¸­å­—å…¸æ¦‚å¿µï¼ŒAnsibleå†…ç½®å˜é‡`ansible_eth0`å°±æ˜¯è¿™æ ·ä¸€ç§å˜é‡ï¼Œå®ƒç”¨æ¥ä¿å­˜è¿œç¨‹ä¸»æœºä¸Šé¢eth0æŽ¥å£çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬IPåœ°å€å’Œå­ç½‘æŽ©ç ç­‰ã€‚ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨debugæ¨¡å—æ¥å±•ç¤ºä¸€ä¸‹å˜é‡`ansible_eth0`çš„å†…å®¹ã€‚

```yaml
---
- hosts: test
  tasks:
    - debug: var=ansible_eth0
```

æ‰§è¡Œç»“æžœï¼š

![](https://xiaoliutalk.gitee.io/img/202302211435794.png)

å½“æˆ‘ä»¬æƒ³è¦è¯»å–å…¶IPv4åœ°å€æ—¶ï¼Œå¯ä½¿ç”¨å¦‚ä¸‹ä¸¤ç§æ–¹æ³•å®žçŽ°ï¼š

```yaml
{{ ansible_eth0.ipv4.address }}
{{ ansible_eth0['ipv4']['address'] }}
```

#### 2.3.5. ä¸»æœºå˜é‡å’Œç»„å˜é‡

- **Inventoryå®šä¹‰å˜é‡**ï¼šå‰æ–‡å·²å­˜åœ¨ç›¸å…³å†…å®¹ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚
- **group_varså’Œhost_vars**ï¼šå‰æ–‡å·²å­˜åœ¨ç›¸å…³å†…å®¹ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚
- **ansibleå†…ç½®å˜é‡**ï¼šAnsibleæä¾›äº†ä¸€äº›éžå¸¸æœ‰ç”¨çš„å†…ç½®å˜é‡ï¼Œè¿™é‡Œæˆ‘ä»¬åˆ—ä¸¾å‡ ä¸ªå¸¸ç”¨çš„ï¼š

| å˜é‡ | å‚æ•° |
| ---- | ---- |
| groups| åŒ…å«äº†æ‰€æœ‰Hostsæ–‡ä»¶é‡Œä¸»æœºç»„çš„ä¸€ä¸ªåˆ—è¡¨ã€‚|
| group_names| åŒ…å«äº†å½“å‰ä¸»æœºæ‰€åœ¨çš„æ‰€æœ‰ä¸»æœºç»„åçš„ä¸€ä¸ªåˆ—è¡¨ã€‚|
| inventory_hostname| é€šè¿‡Hostsæ–‡ä»¶å®šä¹‰ä¸»æœºçš„ä¸»æœºåï¼ˆä¸Žansible_homeä¸ä¸€å®šç›¸åŒï¼‰ã€‚|
| inventory_hostname_short| å˜é‡inventory_hostnameçš„ç¬¬1éƒ¨åˆ†ï¼Œæ¯”å¦‚inventory_hostnameçš„å€¼æ˜¯books.ansible.comï¼Œé‚£ä¹ˆinventory_hostname_shortå°±æ˜¯booksã€‚|
| play_hosts| å°†æ‰§è¡Œå½“å‰ä»»åŠ¡çš„æ‰€æœ‰ä¸»æœºã€‚|
| hostvars | èŽ·å–åˆ°å…¶ä»–ä¸»æœºä¸­çš„ä¿¡æ¯ã€‚ |

#### 2.3.6. Factsï¼ˆæ”¶é›†ç³»ç»Ÿä¿¡æ¯ï¼‰

`Playbook`ä¸­æ‰€æŒ‡å®šçš„æ‰€æœ‰ä¸»æœºçš„ç³»ç»Ÿä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯æˆ‘ä»¬ç§°ä¹‹ä¸º`Facts`ã€‚åœ¨è¿è¡Œä»»ä½•ä¸€ä¸ª`Playbook`ä¹‹å‰ï¼Œ`Ansible`é»˜è®¤ä¼šå…ˆæŠ“å–`Facts`ã€‚

`Facts`ä¿¡æ¯åŒ…æ‹¬ï¼ˆä½†ä¸ä»…é™äºŽï¼‰**è¿œç¨‹ä¸»æœºçš„CPUç±»åž‹ã€IPåœ°å€ã€ç£ç›˜ç©ºé—´ã€æ“ä½œç³»ç»Ÿä¿¡æ¯ä»¥åŠç½‘ç»œæŽ¥å£ä¿¡æ¯**ç­‰ï¼Œè¿™äº›ä¿¡æ¯å¯¹äºŽ`Playbook`çš„è¿è¡Œè‡³å…³é‡è¦ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™äº›ä¿¡æ¯æ¥å†³å®šæ˜¯å¦è¦ç»§ç»­è¿è¡Œä¸‹ä¸€æ­¥ä»»åŠ¡ï¼Œæˆ–è€…å°†è¿™äº›ä¿¡æ¯å†™å…¥æŸä¸ªé…ç½®æ–‡ä»¶ä¸­ã€‚

ä½¿ç”¨`setup`æ¨¡å—æ¥èŽ·å–å¯¹åº”ä¸»æœºä¸Šé¢çš„æ‰€æœ‰å¯ç”¨çš„`Facts`ä¿¡æ¯ï¼š

```bash
ansible test -m setup
```

åœ¨`Playbook`ä»»åŠ¡ä¸­ï¼Œå¦‚æžœä¸éœ€è¦`Facts`ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨`Playbook`ä¸­è®¾ç½® `gather_facts: no` æ¥æš‚æ—¶è®©Ansibleåœ¨æ‰§è¡Œ`Playbook`ä»»åŠ¡ä¹‹å‰è·³è¿‡æ”¶é›†è¿œç¨‹ä¸»æœº`Facts`ä¿¡æ¯è¿™ä¸€æ­¥ï¼Œè¿™æ ·å¯ä»¥ä¸ºä»»åŠ¡èŠ‚çœå‡ ç§’é’Ÿçš„æ—¶é—´ï¼š

```yaml
- hosts: test
  gather_facts: no
```

ðŸ’¡ å¦‚æžœè¿œç¨‹ä¸»æœºä¸Šå®‰è£…äº†`Facter`æˆ–`Ohai`ï¼Œé‚£ä¹ˆ`Ansible`å°†ä¼šæŠŠè¿™ä¸¤ä¸ªè½¯ä»¶æ‰€ç”Ÿæˆçš„`Facts`ä¿¡æ¯ä¹Ÿç»™æ”¶é›†å›žæ¥ï¼Œ`Facts`å˜é‡ååˆ†åˆ«ä»¥`facter_`å’Œ`ohai_`å¼€å¤´è¿›è¡Œæ ‡ç¤ºã€‚

#### 2.3.7. åŠ å¯†æ¨¡å—Vault

è¿è¡ŒæŸäº›ä»»åŠ¡æ—¶ï¼Œä¸å¯é¿å…åœ°ä¼šæŽ¥è§¦åˆ°ä¸€äº›å¯†ç æˆ–å…¶ä»–æ•æ„Ÿæ•°æ®ï¼Œè¿™äº›æ•°æ®æœ‰å¯èƒ½æ˜¯ç®¡ç†å‘˜å¯†ç ã€SSHç§é’¥æˆ–è¿œç¨‹ä¸»æœºçš„è®¤è¯ä¿¡æ¯ï¼Œ`Ansible`è‡ªå¸¦çš„`Vault`åŠ å¯†åŠŸèƒ½ï¼Œ`Vault`å¯ä»¥å°†ç»è¿‡åŠ å¯†çš„å¯†ç å’Œæ•æ„Ÿæ•°æ®åŒ`Playbook`å­˜å‚¨åœ¨ä¸€èµ·ã€‚

å‡å¦‚ä½¿ç”¨API keyçš„æ–¹å¼æ¥è®¿é—®ä¸€ä¸ªæœåŠ¡çš„APIï¼Œè¿™ä¸ªAPI keyå°±å­˜å‚¨åœ¨ä¸€ä¸ªçº¯æ–‡æœ¬æ–‡ä»¶`vars/api_key.yml`ä¸­ï¼š

```yaml
---
- hosts: appserver
  vars_files:
      - vars/api_key.yml
  tasks:
      - name: Connect to service with our API key.
          command: connect_to_service
          environment:
              SERVICE_API_KEY: "{{ myapp_service_api_key }}"
# vars/api_key.yml
---
myapp_service_api_key: â€œyJJvPqhqgxyPZMispRycaVMBmBWPqYDf3DFanPxAMAm4UZcw"
```

æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`ansible-vault`è¿›è¡ŒåŠ å¯†ï¼š

```bash
ansible-vault encrypt api_key.yml
```

`ansible-vault`å¸¸ç”¨å‚æ•°ï¼š

| å˜é‡ | å‚æ•° |
| ---- | ---- |
| encrypt| åŠ å¯†æ–‡ä»¶ã€‚| 
| decrypt| è§£å¯†æ–‡ä»¶ã€‚| 
| edit| ç”¨äºŽç¼–è¾‘ansible-vaultåŠ å¯†è¿‡çš„æ–‡ä»¶ã€‚| 
| rekey| é‡æ–°ä¿®æ”¹å·²è¢«åŠ å¯†æ–‡ä»¶çš„å¯†ç ã€‚| 
| create| åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œå¹¶ç›´æŽ¥å¯¹å…¶è¿›è¡ŒåŠ å¯†ã€‚| 
| view| æŸ¥çœ‹ç»è¿‡åŠ å¯†çš„æ–‡ä»¶ã€‚| 

#### 2.3.8. å˜é‡ä¼˜å…ˆçº§

Ansibleå®˜æ–¹ç»™å‡ºäº†å¦‚ä¸‹ç”±é«˜åˆ°ä½Žçš„ä¼˜å…ˆçº§æŽ’åºï¼š

1. åœ¨å‘½ä»¤è¡Œä¸­å®šä¹‰çš„å˜é‡ï¼ˆå³ç”¨-eå®šä¹‰çš„å˜é‡ï¼‰ã€‚
2. åœ¨Inventoryä¸­å®šä¹‰çš„è¿žæŽ¥å˜é‡ï¼ˆæ¯”å¦‚ansible_ssh_userï¼‰ã€‚
3. å¤§å¤šæ•°çš„å…¶ä»–å˜é‡ï¼ˆå‘½ä»¤è¡Œè½¬æ¢ã€playä¸­çš„å˜é‡ã€includedçš„å˜é‡ã€roleä¸­çš„å˜é‡ç­‰ï¼‰ã€‚
4. åœ¨Inventoryå®šä¹‰çš„å…¶ä»–å˜é‡ã€‚
5. ç”±ç³»ç»Ÿé€šè¿‡gather_factsæ–¹æ³•å‘çŽ°çš„Factsã€‚
6. Roleé»˜è®¤å˜é‡ã€‚

### 2.4. æµç¨‹æŽ§åˆ¶

#### 2.4.1. æ¡ä»¶åˆ¤æ–­-when

ansibleä¸­ï¼Œæ¡ä»¶åˆ¤æ–­çš„å…³é”®å­—æ˜¯ `when` ã€‚

```yaml
# å¦‚æžœansible_distributionçš„å€¼æ˜¯CentOSï¼Œåˆ™æ‰“å°System release is centos
- debug:
      msg: "System release is centos"
    when: ansible_distribution == "CentOS"
```

- `when`å…³é”®å­—ä¸­å¼•ç”¨å˜é‡æ—¶ï¼Œå˜é‡åä¸éœ€è¦åŠ `{{ }}`ã€‚
- ansibleä½¿ç”¨`jinja2`æ¨¡æ¿å¼•æ“Žï¼Œåœ¨ansibleä¸­ä¹Ÿå¯ä»¥ç›´æŽ¥ä½¿ç”¨`jinja2`çš„è¿™äº›è¿ç®—ç¬¦ã€‚å¦‚åŠ ã€å‡ã€ä¹˜ã€é™¤å’Œæ¯”è¾ƒï¼ˆ==è¡¨ç¤ºç›¸ç­‰ï¼Œï¼=è¡¨ç¤ºä¸ç›¸ç­‰ï¼Œ>=è¡¨ç¤ºå¤§äºŽç­‰äºŽï¼Œç­‰ç­‰ï¼‰ã€‚é€»è¾‘è¿ç®—ç¬¦æ”¯æŒ`and`ï¼ˆä¸Žï¼‰ã€`or`ï¼ˆæˆ–ï¼‰ã€`not`ï¼ˆéžï¼‰ï¼Œå¯ä»¥ä½¿ç”¨å°æ‹¬å·æ¥å¯¹é€»è¾‘è¿ç®—ç¬¦è¿›è¡Œåˆ†ç»„ä½¿ç”¨ã€‚
- åœ¨å°‘æ•°`Jinja2`å¹¶ä¸èƒ½å‘æŒ¥å¼ºå¤§åŠŸèƒ½çš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Pythonçš„å†…ç½®æ–¹æ³•æ¥è¿›è¡Œè¡¥å……ï¼Œæ¯”å¦‚ï¼š`string.split`å’Œ`[number].is_signedï¼ˆï¼‰`ã€‚

#### 2.4.2. æ¡ä»¶åˆ¤æ–­-changed_whenï¼Œfailed_when

**changed_when**

å½“æˆ‘ä»¬ä½¿ç”¨æŸäº›æ¨¡å—æ—¶ï¼Œå¦‚æžœä¸ä½¿ç”¨`changed_when`è¯­å¥ï¼Œ`Ansible`å°†æ°¸è¿œè¿”å›ž`changed`ã€‚å¦‚æžœä½¿ç”¨`changed_when`è¯­å¥ï¼Œå¹¶ç»“åˆæ³¨å†Œå˜é‡å¯¹ä»»åŠ¡è¿”å›žç»“æžœè¿›è¡Œåˆ¤æ–­åŽï¼Œå†æ¥å†³å®šæ˜¯å¦æ˜¾ç¤ºçŠ¶æ€ä¸º`changed`ï¼Œå°†æ›´åŠ ç¬¦åˆæˆ‘ä»¬çš„å®žé™…éœ€æ±‚ã€‚

```yaml
---
- name: Test changed_when
  hosts: test
  remote_user: root
  tasks: 
  - debug:
      msg: "ansible change test"
    changed_when: 0 > 1
```

**failed_when**

æœ‰ä¸€äº›å‘½ä»¤ä¼šå°†è‡ªå·±çš„è¿è¡Œç»“æžœå†™å…¥æ ‡å‡†é”™è¯¯è¾“å‡º`stderr`ä¸­ï¼Œè€Œä¸æ˜¯é€šå¸¸çš„æ ‡å‡†è¾“å‡º`stdout`ä¸­ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨`failed_when`æ¥å¯¹ç»“æžœè¿›è¡Œåˆ¤æ–­ï¼Œä»Žè€Œå‘Šè¯‰`Ansible`çœŸæ­£çš„è¿è¡Œç»“æžœåˆ°åº•æ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ã€‚

```bash
---
- hosts: test
  gather_facts: no
  remote_user: root
  tasks:
  - name: é€šè¿‡CLIå¯¼å…¥Jenkinsä»»åŠ¡
    shell: >
        java -jar /opt/jenkins-cli.jar -s http://localhost:8080/
        create-job "My Job" < /usr/local/my-job.xml
    register: import
    failed_when: "import.stderr and 'already exists' not in import.stderr"
```

#### 2.4.3. æ¡ä»¶åˆ¤æ–­-ignore_errors

ä¸€äº›å¿…é¡»è¿è¡Œçš„å‘½ä»¤æˆ–è„šæœ¬ä¼šæŠ¥ä¸€äº›é”™è¯¯ï¼Œä¼šç›´æŽ¥å¯¼è‡´`Playbook`è¿è¡Œä¸­æ–­ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç›¸å…³ä»»åŠ¡ä¸­æ·»åŠ `ignore_errors: true`æ¥å±è”½æ‰€æœ‰é”™è¯¯ä¿¡æ¯ï¼Œ`Ansible`ä¹Ÿå°†è§†è¯¥ä»»åŠ¡è¿è¡ŒæˆåŠŸã€‚

```yaml
---
- hosts: test
  gather_facts: no
  remote_user: root
  ignore_errors: true
  tasks:
  - command: "ls -alh /"
    register: ls
    changed_when: "'root' in ls"
```

#### 2.4.4. Blockå—

åœ¨ansibleä¸­ï¼Œå¯ä»¥ä½¿ç”¨`block`å…³é”®å­—å°†å¤šä¸ªä»»åŠ¡æ•´åˆæˆä¸€ä¸ªå—ï¼Œè¿™ä¸ªå—å°†è¢«å½“åšä¸€ä¸ªæ•´ä½“ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹è¿™ä¸ªå—æ·»åŠ åˆ¤æ–­æ¡ä»¶ï¼Œå—åŠŸèƒ½å¯ä»¥å°†ä»»åŠ¡è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ä¸”å¯ä»¥åœ¨å—çº§åˆ«ä¸Šåº”ç”¨ä»»åŠ¡å˜é‡ã€‚

```yaml
# æ ¹æ®ç³»ç»Ÿç‰ˆæœ¬æ¥åŒºåˆ†apacheåŒ…åç§°ï¼Œè·¯å¾„ï¼Œå¹¶å®‰è£…apache
---
- hosts: web
  tasks:
      # Install and configure Apache on RedHat/CentOS hosts.
      - block:
          - yum: name=httpd state=present
          - template: src=httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf
          - service: name=httpd state=started enabled=yes
      when: ansible_os_family == 'RedHat'
      sudo: yes

      # Install and configure Apache on Debian/Ubuntu hosts.
      - block:
          - apt: name=apache2 state=present
          - template: src=httpd.conf.j2 dest=/etc/apache2/apache2.conf
          - service: name=apache2 state=started enabled=yes
      when: ansible_os_family == 'Debian'
      sudo: yes
```

å—åŠŸèƒ½ä¹Ÿå¯ä»¥ç”¨æ¥å¤„ç†ä»»åŠ¡çš„å¼‚å¸¸ã€‚ç®€å•ç†è§£ä¸ºtry...catch...finallyå³å¯ã€‚

```yaml
tasks:
    - block:
      - name: Shell script to connect the app to a monitoring service.
        script: monitoring-connect.sh
        rescue:
        - name: åªæœ‰è„šæœ¬æŠ¥é”™æ—¶æ‰æ‰§è¡Œ
          debug: msg="There was an error in the block."
        always:
        - name: æ— è®ºç»“æžœå¦‚ä½•éƒ½æ‰§è¡Œ
          debug: msg="This always executes."
```

å½“å—ä¸­çš„ä»»æ„ä»»åŠ¡å‡ºé”™æ—¶ï¼Œ`rescue`å…³é”®å­—å¯¹åº”çš„ä»£ç å—å°±ä¼šè¢«æ‰§è¡Œï¼Œè€Œ`always`å…³é”®å­—å¯¹åº”çš„ä»£ç å—æ— è®ºå¦‚ä½•éƒ½ä¼šè¢«æ‰§è¡Œã€‚

### 2.5. å¾ªçŽ¯

#### 2.5.1. with_itemsï¼Œwith_flattened

`with_items`ã€ `with_flattened`å…³é”®å­—ä¼šæŠŠè¿”å›žçš„åˆ—è¡¨ä¿¡æ¯è‡ªåŠ¨å¤„ç†ï¼Œå°†æ¯ä¸€æ¡ä¿¡æ¯å•ç‹¬æ”¾åœ¨ä¸€ä¸ªåä¸º`item`çš„å˜é‡ä¸­ï¼Œæˆ‘ä»¬åªè¦èŽ·å–åˆ°åä¸º`item`å˜é‡çš„å˜é‡å€¼ï¼Œå³å¯å¾ªçŽ¯çš„èŽ·å–åˆ°åˆ—è¡¨ä¸­çš„æ¯ä¸€æ¡ä¿¡æ¯ã€‚

ç¤ºä¾‹å¦‚ä¸‹ï¼š

```yaml
---
- hosts: test
  gather_facts: no
  remote_user: root
  tasks:
    - name: add several users
      user: name={{ item }} state=present groups=wheel
      with_items:
         - testuser1
         - testuser2
```

è‡ªå®šä¹‰åˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ªæ¡ç›®éƒ½æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œå¯ä»¥é€šè¿‡`item.key`èŽ·å–å¯¹åº”çš„å€¼ã€‚

```yaml
---
- hosts: test
  gather_facts: no
  remote_user: root
  tasks:
    - name: add several users
      user: name={{ item.name }} state=present groups={{ item.groups }}
      with_items:
        - 
          name: 'testuser1'
          groups: 'wheel'
        - 
          name: 'testuser2'
          groups: 'root'
```

#### 2.5.2. with_list

`with_items`ã€ `with_flattened`å…³é”®å­—ä¼šæŠŠåˆ—è¡¨ä¸­çš„å€¼æŒ‰é¡ºåºè¿›è¡Œæ‰§è¡Œï¼Œä½†æ˜¯`with_list`å…³é”®å­—ä¼šæŠŠåˆ—è¡¨æŒ‰ç…§æ•´ä½“è¿›è¡Œæ‰§è¡Œã€‚

```yaml
---
- hosts: test
  remote_user: root
  gather_facts: no
  tasks:
  - debug:
      msg: "{{item}}"
    with_items:
    - [ 1, 2, 3 ]
    - [ a, b ]
```

`with_items`æ‰“å°ï¼š

![image-20230224110427182](https://xiaoliutalk.gitee.io/img/202302241104386.png)

`with_list`æ‰“å°ï¼š

![image-20230224110502712](https://xiaoliutalk.gitee.io/img/202302241105272.png)

#### 2.5.3. with_together

å¦‚æžœä½ æƒ³å¾—åˆ°`(a, 1)`å’Œ`(b, 2)`ä¹‹ç±»çš„é›†åˆ.å¯ä»¥ä½¿ç”¨`with_together`ï¼š

```yaml
---
- hosts: test
  remote_user: root
  gather_facts: no
  tasks:
    - debug: msg="{{ item.0 }} and {{ item.1 }}"
      with_together: 
        - [ 'a', 'b', 'c','d' ]
        - [ 1, 2, 3, 4 ]
```

#### 2.5.4. with_cartesian

`with_cartesian`å…³é”®å­—çš„ä½œç”¨å°±æ˜¯å°†æ¯ä¸ªå°åˆ—è¡¨ä¸­çš„å…ƒç´ æŒ‰ç…§`ç¬›å¡å°”ç§¯`çš„æ–¹å¼ç»„åˆã€‚

```yaml
---
- hosts: test
  remote_user: root
  gather_facts: no
  tasks:
    - debug: msg="{{ item.0 }} and {{ item.1 }}"
      with_cartesian: 
        - [ 'a', 'b', 'c','d' ]
        - [ 1, 2, 3, 4 ]
```

![image-20230224141656065](https://xiaoliutalk.gitee.io/img/202302241418201.png)

#### 2.5.5. with_sequence

`with_sequence` å…³é”®å­—å¯ä»¥ä»¥æ•°å­—é¡ºåºç”Ÿæˆä¸€ç»„åºåˆ—ã€‚ä½ å¯ä»¥æŒ‡å®šèµ·å§‹å€¼ï¼ˆ**start**ï¼‰ã€ç»ˆæ­¢å€¼ï¼ˆ**end**ï¼‰ã€ä»¥åŠå¯é€‰çš„æ­¥é•¿å€¼ï¼ˆ**stride**ï¼‰ï¼Œå’Œæ•°æ®æ ¼å¼åŒ–çš„åŠŸèƒ½ï¼ˆ**format**ï¼‰ã€‚

ç¤ºä¾‹å¦‚ä¸‹ï¼š

```yaml
---
- hosts: test
  remote_user: root
  gather_facts: no
  tasks:
  - file:
      path: "/testdir/testdir/test{{ item }}"
      state: directory
    with_sequence:
      start=2
      end=10
      stride=2
```

#### 2.5.6. with_dict

`with_dict`å…³é”®å­—å¯ä»¥å¤„ç†å­—å…¸å˜é‡ï¼Œé€šè¿‡`key`å…³é”®å­—å’Œ`value`å…³é”®å­—åˆ†åˆ«èŽ·å–åˆ°å­—å…¸ä¸­é”®å€¼å¯¹çš„é”®å’Œå€¼ã€‚

```yaml
---
- hosts: test
  remote_user: root
  vars:
    users:
      alice:
        name: Alice Appleworth
        telephone: 123-456-7890
      bob:
        name: Bob Bananarama
        telephone: 987-654-3210
  gather_facts: no
  tasks:
    - name: Print phone records
      debug: msg="User {{ item.key }} is {{ item.value.name }} ({{ item.value.telephone }})"
      with_dict: "{{users}}"
```

#### 2.5.7. with_subelementsï¼ˆæœªå®Œæˆï¼‰

```yaml
---
- hosts: test
  remote_user: root
  gather_facts: no
  vars:
    users:
      - name: alice
        authorized:
          - /tmp/alice/onekey.pub
          - /tmp/alice/twokey.pub
        mysql:
            password: mysql-password
            hosts:
              - "%"
              - "127.0.0.1"
              - "::1"
              - "localhost"
            privs:
              - "*.*:SELECT"
              - "DB1.*:ALL"
      - name: bob
        authorized:
          - /tmp/bob/id_rsa.pub
        mysql:
            password: other-mysql-password
            hosts:
              - "db1"
            privs:
              - "*.*:SELECT"
              - "DB2.*:ALL"
  tasks:
    - user: name={{ item.name }} state=present generate_ssh_key=yes
      with_items: "{{users}}"
    
    - authorized_key: "user={{ item.0.name }} key='{{ lookup('file', item.1) }}'"
      with_subelements:
         - users
         - authorized
```

#### 2.5.8. with_file

`with_file`å…³é”®å­—èŽ·å–åˆ°`ansible`ä¸»æœºä¸­çš„æ–‡ä»¶å†…å®¹ã€‚

```yaml
---
- hosts: test
  remote_user: root
  gather_facts: no
  tasks:
    - debug:
        msg: "{{ item }}"
      with_file:
      - /tmp/1.txt
      - /tmp/2.txt
```

#### 2.5.9. with_fileglob

`with_fileglob`å…³é”®å­—ç”¨æ¥åŒ¹é…æ–‡ä»¶åç§°ã€‚

```yaml
---
- hosts: test
  remote_user: root
  gather_facts: no
  tasks:
    - debug:
        msg: "{{ item }}"
      with_fileglob:
      - /tmp/*
      - /tmp/*.???
```

### 2.6. ä»»åŠ¡é—´æµç¨‹æŽ§åˆ¶

#### 2.6.1. ä»»åŠ¡å§”æ‰˜

Ansibleçš„ä»»åŠ¡å§”æ‰˜åŠŸèƒ½å¯ä»¥åœ¨ç‰¹å®šçš„ä¸»æœºä¸Šè¿è¡Œä»»åŠ¡ã€‚`delegate_to`å¯ä»¥æŠŠæŸä¸€ä¸ªä»»åŠ¡æ”¾åœ¨å§”æ‰˜çš„æœºå™¨ä¸Šæ‰§è¡Œã€‚

```yaml
# Test delegate_to
---
- name: Test delegate_to
  hosts: test
  gather_facts: false
  tasks:
    - name: Test delegate_to
      ansible.builtin.debug:
        msg: "ansible delegate_to test"
      delegate_to: 127.0.0.1
```

#### 2.6.2. ä»»åŠ¡æš‚åœ

æœ‰äº›æƒ…å†µä¸‹ï¼Œä¸€äº›ä»»åŠ¡çš„è¿è¡Œéœ€è¦ç­‰å¾…ä¸€äº›çŠ¶æ€çš„æ¢å¤ï¼Œæ¯”å¦‚æŸä¸€å°ä¸»æœºæˆ–è€…åº”ç”¨åˆšåˆšé‡å¯ï¼Œæˆ‘ä»¬éœ€è¦ç­‰å¾…å®ƒä¸Šé¢çš„æŸä¸ªç«¯å£å¼€å¯ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±ä¸å¾—ä¸å°†æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡æš‚åœï¼Œç›´åˆ°å…¶çŠ¶æ€æ»¡è¶³æˆ‘ä»¬éœ€æ±‚ã€‚

`Ansible`æä¾›äº†wait_foræ¨¡å—ä»¥å®žçŽ°ä»»åŠ¡æš‚åœçš„éœ€æ±‚ï¼Œ`wait_for`æ¨¡å—å¸¸ç”¨å‚æ•°ï¼š

| å˜é‡ | å‚æ•° |
| ---- | ---- |
|connect_timeout|åœ¨ä¸‹ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œä¹‹å‰ç­‰å¾…è¿žæŽ¥çš„è¶…æ—¶æ—¶é—´|
|delay|ç­‰å¾…ä¸€ä¸ªç«¯å£æˆ–è€…æ–‡ä»¶æˆ–è€…è¿žæŽ¥åˆ°æŒ‡å®šçš„çŠ¶æ€æ—¶ï¼Œé»˜è®¤è¶…æ—¶æ—¶é—´ä¸º300ç§’ï¼Œåœ¨è¿™ç­‰å¾…çš„300sçš„æ—¶é—´é‡Œï¼Œwait_foræ¨¡å—ä¼šä¸€ç›´è½®è¯¢æŒ‡å®šçš„å¯¹è±¡æ˜¯å¦åˆ°è¾¾æŒ‡å®šçš„çŠ¶æ€ï¼Œdelayå³ä¸ºå¤šé•¿æ—¶é—´è½®è¯¢ä¸€æ¬¡çŠ¶æ€ã€‚|
|host|wait_foræ¨¡å—ç­‰å¾…çš„ä¸»æœºçš„åœ°å€ï¼Œé»˜è®¤ä¸º127.0.0.1|
|port|wait_foræ¨¡å—å¾…å¾…çš„ä¸»æœºçš„ç«¯å£|
|path|æ–‡ä»¶è·¯å¾„ï¼Œåªæœ‰å½“è¿™ä¸ªæ–‡ä»¶å­˜åœ¨æ—¶ï¼Œä¸‹ä¸€ä»»åŠ¡æ‰å¼€å§‹æ‰§è¡Œï¼Œå³ç­‰å¾…è¯¥æ–‡ä»¶åˆ›å»ºå®Œæˆ|
|state|ç­‰å¾…çš„çŠ¶æ€ï¼Œå³ç­‰å¾…çš„æ–‡ä»¶æˆ–ç«¯å£æˆ–è€…è¿žæŽ¥çŠ¶æ€è¾¾åˆ°æŒ‡å®šçš„çŠ¶æ€æ—¶ï¼Œä¸‹ä¸€ä¸ªä»»åŠ¡å¼€å§‹æ‰§è¡Œã€‚å½“ç­‰å¾…çš„å¯¹è±¡ä¸ºç«¯å£æ—¶ï¼ŒçŠ¶æ€æœ‰startedï¼Œstopedï¼Œå³ç«¯å£å·²ç»ç›‘å¬æˆ–è€…ç«¯å£å·²ç»å…³é—­ï¼›å½“ç­‰å¾…çš„å¯¹è±¡ä¸ºæ–‡ä»¶æ—¶ï¼ŒçŠ¶æ€æœ‰present(å­˜åœ¨)æˆ–è€…startedï¼Œabsent(ä¸å­˜åœ¨)ï¼Œå³æ–‡ä»¶å·²åˆ›å»ºæˆ–è€…åˆ é™¤ï¼›å½“ç­‰å¾…çš„å¯¹è±¡ä¸ºä¸€ä¸ªè¿žæŽ¥æ—¶ï¼ŒçŠ¶æ€æœ‰drainedï¼Œå³è¿žæŽ¥å·²å»ºç«‹ã€‚é»˜è®¤ä¸ºstarted|
|timeout|wait_forçš„ç­‰å¾…çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º300ç§’|

ç¤ºä¾‹å¦‚ä¸‹ï¼š

```yaml
- name: Wait for webserver to start.
  local_action:
      module: wait_for
      host: webserver1
      port: 80
      delay: 10
      timeout: 300
      state: started
```

### 2.7. äº¤äº’å¼æç¤º

Ansibleä»»åŠ¡è¿è¡Œçš„è¿‡ç¨‹ä¸­éœ€è¦ç”¨æˆ·è¾“å…¥ä¸€äº›æ•°æ®ï¼Œ`vars_prompt`å…³é”®å­—ç”¨æ¥å¤„ç†ä¸Šè¿°è¿™ç§ä¸Žç”¨æˆ·äº¤äº’çš„æƒ…å†µã€‚

```yaml
---
- hosts: test
  vars_prompt:
  - name: share_user
    prompt: "What is your network username?"
  - name: share_pass
    prompt: "What is your network password?"
    private: yes
```

`vars_prompt`å‡ ä¸ªå¸¸ç”¨çš„é€‰é¡¹ï¼š

| å˜é‡    | å‚æ•°                                                         |
| ------- | ------------------------------------------------------------ |
| private | è¯¥å€¼ä¸ºyesï¼Œå³ç”¨æˆ·æ‰€æœ‰çš„è¾“å…¥åœ¨å‘½ä»¤ä¸­é»˜è®¤éƒ½æ˜¯ä¸å¯è§çš„ã€‚        |
| default | ä¸ºå˜é‡è®¾ç½®é»˜è®¤å€¼ï¼Œä»¥èŠ‚çœç”¨æˆ·è¾“å…¥æ—¶é—´ã€‚                       |
| confirm | ç‰¹åˆ«é€‚åˆè¾“å…¥å¯†ç çš„æƒ…å†µï¼Œå¦‚æžœå°†å€¼è®¾ä¸ºyesï¼Œåˆ™ä¼šè¦æ±‚ç”¨æˆ·è¾“å…¥ä¸¤æ¬¡ï¼Œä»¥å¢žåŠ è¾“å…¥çš„æ­£ç¡®æ€§ã€‚ |

### 2.8. Tags

Ansibleçš„æ ‡ç­¾ï¼ˆ`Tags`ï¼‰åŠŸèƒ½å¯ä»¥ç»™è§’è‰²ï¼ˆ`Roles`ï¼‰ã€æ–‡ä»¶ã€å•ç‹¬çš„ä»»åŠ¡ç”šè‡³æ•´ä¸ª`Playbook`æ‰“ä¸Šæ ‡ç­¾ï¼Œç„¶åŽåˆ©ç”¨è¿™äº›æ ‡ç­¾æ¥æŒ‡å®šè¦è¿è¡ŒPlaybookä¸­çš„ä¸ªåˆ«ä»»åŠ¡ï¼Œæˆ–ä¸æ‰§è¡ŒæŒ‡å®šçš„ä»»åŠ¡ã€‚

ç¤ºä¾‹å¦‚ä¸‹ï¼š

```yaml
---
# å¯ä»¥ç»™æ•´ä¸ªPlaybookçš„æ‰€æœ‰ä»»åŠ¡æ‰“ä¸€ä¸ªæ ‡ç­¾
- hosts: test
  tags: deploy
  roles:
      # ç»™è§’è‰²æ‰“çš„æ ‡ç­¾å°†ä¼šåº”ç”¨äºŽè§’è‰²ä¸‹æ‰€æœ‰çš„ä»»åŠ¡
      - { role: tomcat, tags: ['tomcat', 'app'] }
  tasks:
          - name: Notify on completion.
            local_action:
               module: osx_say
               msg: "{{inventory_hostname}} is finished!"
               voice: Zarvox
            tags:
               - notifications
               - say
          - include: foo.yml
            tags: foo
```



